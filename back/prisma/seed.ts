import { PrismaClient } from "@prisma/client";
import * as bcrypt from "bcrypt";
import { randomBytes } from "crypto";

const prisma = new PrismaClient();

/**
 * ÐœÐ°ÑÑÐ¸Ð² Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ
 * Ð›ÐµÐ³ÐºÐ¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ñ… Ð°Ð´Ð¼Ð¸Ð½Ð¾Ð² - Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¾Ð±ÑŠÐµÐºÑ‚ Ð² Ð¼Ð°ÑÑÐ¸Ð²
 */
const admins = [
  {
    email: "effectcor@gmail.com",
    password: "testtest",
    username: "effectcor",
    fullName: "Effectcor Admin",
  },
  {
    email: "gulopavel@gmail.com",
    password: "testtest",
    username: "gulopavel",
    fullName: "Gulopavel Admin",
  },
  // Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð½Ð¾Ð²Ñ‹Ñ… Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² Ð·Ð´ÐµÑÑŒ:
  // {
  //   email: "newadmin@example.com",
  //   password: "password123",
  //   username: "newadmin",
  //   fullName: "New Admin",
  // },
];

async function main() {
  console.log("ðŸŒ± ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ seed Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²...\n");

  for (const adminData of admins) {
    try {
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ
      const existingUser = await prisma.user.findFirst({
        where: {
          OR: [{ email: adminData.email }, { username: adminData.username }],
        },
      });

      if (existingUser) {
        // Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐµÐ³Ð¾ Ñ€Ð¾Ð»ÑŒ Ð½Ð° admin
        if (existingUser.role !== "admin") {
          await prisma.user.update({
            where: { id: existingUser.id },
            data: { role: "admin" },
          });
          console.log(
            `âœ… ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${adminData.email} Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½ Ð´Ð¾ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°`
          );
        } else {
          console.log(
            `â„¹ï¸  ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${adminData.email} ÑƒÐ¶Ðµ ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼`
          );
        }
        continue;
      }

      // Ð¥ÐµÑˆÐ¸Ñ€ÑƒÐµÐ¼ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ
      const hashedPassword = await bcrypt.hash(adminData.password, 12);

      // Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ userId (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 8 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² hex Ð² Ð²ÐµÑ€Ñ…Ð½ÐµÐ¼ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ðµ)
      const userId = randomBytes(4).toString("hex").toUpperCase();

      // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°
      const admin = await prisma.user.create({
        data: {
          email: adminData.email,
          username: adminData.username,
          passwordHash: hashedPassword,
          fullName: adminData.fullName,
          userId,
          role: "admin",
        },
      });

      // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð±Ð°Ð»Ð°Ð½Ñ
      await prisma.balance.create({
        data: {
          userId: admin.id,
          amount: 0,
        },
      });

      console.log(`âœ… ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€ ÑÐ¾Ð·Ð´Ð°Ð½: ${adminData.email}`);
      console.log(`   Username: ${admin.username}`);
      console.log(`   UserId: ${admin.userId}`);
      console.log(`   ID: ${admin.id}\n`);
    } catch (error) {
      console.error(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° ${adminData.email}:`, error);
    }
  }

  console.log("âœ¨ Seed Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!");
}

main()
  .catch((e) => {
    console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ seed:", e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });

