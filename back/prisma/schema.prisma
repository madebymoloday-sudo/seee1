// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum TransactionType {
  PAYMENT
  WITHDRAWAL
}

enum RootBeliefStatus {
  IDENTIFIED
  TRANSFORMED
  COMPLETED
}

enum FeedbackType {
  FULL
  QUICK
}

enum FeedbackStatus {
  NEW
  IN_PROGRESS
  RESOLVED
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING
}

enum SubscriptionPlan {
  MONTHLY
  QUARTERLY
  YEARLY
}

// Models
model User {
  id            String   @id @default(uuid())
  username      String   @unique
  email         String?  @unique
  passwordHash  String   @map("password_hash")
  googleId      String?  @unique @map("google_id")
  telegramId    String?  @unique @map("telegram_id")
  fullName      String?  @map("full_name")
  language      String   @default("ru")
  userId        String?  @unique @map("user_id")
  avatarUrl     String?  @map("avatar_url")
  role          String   @default("user") // 'user' | 'admin'

  sessions           Session[]
  eventMap           EventMap[]
  beforeAfterBeliefs BeforeAfterBelief[]
  feedback           Feedback[]
  rootBeliefs        RootBelief[]
  sessionJournal     SessionJournal[]
  interestingThoughts InterestingThought[]
  balances           Balance[]
  transactions       Transaction[]
  paymentDetails     PaymentDetails?
  refreshTokens      RefreshToken[]
  subscription       Subscription?
  gptStatistics      GptStatistics[]
  pipelinePrograms   PipelineProgram[]

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  title     String?

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]
  conceptHierarchies ConceptHierarchy[]
  beforeAfterBeliefs BeforeAfterBelief[]
  feedback  Feedback[]
  rootBeliefs RootBelief[]
  sessionJournal SessionJournal[]
  interestingThoughts InterestingThought[]
  gptStatistics GptStatistics?
  pipelineState PipelineState?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([userId, createdAt])
  @@map("sessions")
}

model Message {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  role      String   // 'user' | 'assistant'
  content   String

  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  timestamp DateTime @default(now())

  @@index([sessionId])
  @@index([sessionId, timestamp])
  @@map("messages")
}

model EventMap {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  eventNumber Int      @map("event_number")
  event       String
  emotion     String
  idea        String
  rootBelief  String?  @map("root_belief")
  isCompleted Boolean  @default(false) @map("is_completed")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("event_map")
}

model BeforeAfterBelief {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  sessionId   String?  @map("session_id")
  beliefBefore String  @map("belief_before")
  beliefAfter  String? @map("belief_after")
  isTask      Boolean  @default(false) @map("is_task")
  circleNumber Int?    @map("circle_number")
  circleName   String? @map("circle_name")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  session     Session? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([sessionId])
  @@map("before_after_beliefs")
}

model Balance {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  amount    Decimal  @default(0) @db.Decimal(10, 2)

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("balances")
}

model Transaction {
  id              String          @id @default(uuid())
  userId          String          @map("user_id")
  amount          Decimal         @db.Decimal(10, 2)
  transactionType TransactionType @map("transaction_type")
  description     String?

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime        @default(now()) @map("created_at")

  @@index([userId])
  @@map("transactions")
}

model RootBelief {
  id            String            @id @default(uuid())
  userId        String            @map("user_id")
  sessionId     String?           @map("session_id")
  circleNumber  Int               @map("circle_number")
  circleName    String            @map("circle_name")
  negativeBelief String           @map("negative_belief")
  positiveBelief String?          @map("positive_belief")
  isTask        Boolean           @default(false) @map("is_task")
  status        RootBeliefStatus   @default(IDENTIFIED)

  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  session       Session?          @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  @@index([userId])
  @@index([sessionId])
  @@map("root_beliefs")
}

model Feedback {
  id          String         @id @default(uuid())
  userId      String         @map("user_id")
  sessionId   String?        @map("session_id")
  description String
  filePath    String?        @map("file_path")
  fileType    String?        @map("file_type")
  feedbackType FeedbackType  @default(FULL) @map("feedback_type")
  status      FeedbackStatus @default(NEW)

  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  session     Session?       @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  files       FeedbackFile[]

  createdAt   DateTime       @default(now()) @map("created_at")

  @@index([userId])
  @@index([status])
  @@map("feedback")
}

model FeedbackFile {
  id          String   @id @default(uuid())
  feedbackId String   @map("feedback_id")
  filePath   String   @map("file_path")
  fileType   String?  @map("file_type")

  feedback   Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now()) @map("created_at")

  @@index([feedbackId])
  @@map("feedback_files")
}

model ConceptHierarchy {
  id          String   @id @default(uuid())
  sessionId   String   @map("session_id")
  conceptData Json     @map("concept_data")

  session     Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @map("created_at")

  @@index([sessionId])
  @@map("concept_hierarchies")
}

model SessionJournal {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  sessionId         String?  @map("session_id")
  dateTime          DateTime @map("date_time")
  feelingAfter      String?  @map("feeling_after")
  emotionAfter      String?  @map("emotion_after")
  howSessionWent    String?  @map("how_session_went")
  interestingThoughts String? @map("interesting_thoughts")

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  session           Session? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  createdAt         DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([sessionId])
  @@map("session_journal")
}

model InterestingThought {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  sessionId   String?  @map("session_id")
  thoughtNumber Int     @map("thought_number")
  title       String
  thoughtText String   @map("thought_text")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  session     Session? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([sessionId])
  @@map("interesting_thoughts")
}

model GptStatistics {
  id                      String   @id @default(uuid())
  sessionId               String   @unique @map("session_id")
  userId                  String   @map("user_id")
  messageCount            Int      @default(0) @map("message_count")
  avgResponseTime         Float?   @map("avg_response_time")
  userSatisfactionScore   Float?   @map("user_satisfaction_score")
  difficultyEncountered    Int      @default(0) @map("difficulty_encountered")
  rootBeliefsIdentified    Int      @default(0) @map("root_beliefs_identified")
  positiveTransformations Int      @default(0) @map("positive_transformations")

  session                 Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  @@map("gpt_statistics")
}

model PaymentDetails {
  id          String   @id @default(uuid())
  userId      String   @unique @map("user_id")
  fullName    String?  @map("full_name")
  phone       String?
  birthDate   DateTime? @map("birth_date") @db.Date
  inn         String?
  paymentForm String?  @map("payment_form")
  detailsJson Json?    @map("details_json")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("payment_details")
}

model RefreshToken {
  id        String   @id
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Subscription {
  id            String            @id @default(uuid())
  userId        String            @unique @map("user_id")
  plan          SubscriptionPlan
  status        SubscriptionStatus @default(PENDING)
  expiresAt     DateTime?         @map("expires_at")
  autoRenew     Boolean           @default(true) @map("auto_renew")
  paymentMethod String?           @map("payment_method")
  lavaOrderId   String?           @unique @map("lava_order_id")

  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@map("subscriptions")
}

model PromoCode {
  id            String    @id @default(uuid())
  code          String    @unique
  discountAmount Decimal?  @map("discount_amount") @db.Decimal(10, 2)
  discountPercent Int?    @map("discount_percent")
  isActive      Boolean   @default(true) @map("is_active")
  expiresAt     DateTime? @map("expires_at")
  maxUses       Int?      @map("max_uses")
  currentUses   Int       @default(0) @map("current_uses")

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("promo_codes")
}

model PipelineState {
  id        String   @id @default(uuid())
  sessionId String   @unique @map("session_id")
  stateJson Json     @map("state_json")

  session   Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("pipeline_states")
}

model PipelineProgram {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  version     String?
  description String?
  configJson  Json     @map("config_json")
  isDefault   Boolean  @default(false) @map("is_default")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([userId, name])
  @@map("pipeline_programs")
}

